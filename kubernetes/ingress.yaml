---
# HTTP to HTTPS redirect
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
    name: epicalendar-ingress-redirect
    namespace: epicalendar
    labels:
        app: epicalendar
        environment: production
spec:
    entryPoints:
        - web
    routes:
        - match: Host(`epicalendar.tek-nice.eu`) || Host(`www.epicalendar.tek-nice.eu`)
          kind: Rule
          services:
              - name: client-service
                port: 3000
          middlewares:
              - name: redirect-to-https

---
# Main HTTPS Ingress with Let's Encrypt
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
    name: epicalendar-ingress
    namespace: epicalendar
    labels:
        app: epicalendar
        environment: production
    annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
    entryPoints:
        - websecure
    routes:
        - match: Host(`epicalendar.tek-nice.eu`) || Host(`www.epicalendar.tek-nice.eu`)
          kind: Rule
          services:
              - name: client-service
                port: 3000
          middlewares:
              - name: security-headers
              - name: rate-limit
        - match: Host(`epicalendar.tek-nice.eu`) && PathPrefix(`/api`)
          kind: Rule
          services:
              - name: server-service
                port: 5000
          middlewares:
              - name: security-headers
              - name: rate-limit
    tls:
        secretName: epicalendar-tls-cert
        domains:
            - main: epicalendar.tek-nice.eu
              sans:
                  - www.epicalendar.tek-nice.eu

---
# Traditional Kubernetes Ingress (fallback)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
    name: epicalendar-ingress-k8s
    namespace: epicalendar
    labels:
        app: epicalendar
        environment: production
    annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-prod"
        cert-manager.io/acme-challenge-type: http01
        traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
        traefik.ingress.kubernetes.io/router.middlewares: epicalendar-redirect-to-https@kubernetescrd,epicalendar-security-headers@kubernetescrd
        traefik.ingress.kubernetes.io/redirect-entry-point: websecure
        traefik.ingress.kubernetes.io/redirect-permanent: "true"
spec:
    ingressClassName: traefik
    tls:
        - hosts:
              - epicalendar.tek-nice.eu
              - www.epicalendar.tek-nice.eu
          secretName: epicalendar-tls-cert
    rules:
        - host: epicalendar.tek-nice.eu
          http:
              paths:
                  - path: /api
                    pathType: Prefix
                    backend:
                        service:
                            name: server-service
                            port:
                                number: 5000
                  - path: /
                    pathType: Prefix
                    backend:
                        service:
                            name: client-service
                            port:
                                number: 3000
        - host: www.epicalendar.tek-nice.eu
          http:
              paths:
                  - path: /api
                    pathType: Prefix
                    backend:
                        service:
                            name: server-service
                            port:
                                number: 5000
                  - path: /
                    pathType: Prefix
                    backend:
                        service:
                            name: client-service
                            port:
                                number: 3000

---
# Middleware for HTTPS redirect
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
    name: redirect-to-https
    namespace: epicalendar
spec:
    redirectScheme:
        scheme: https
        permanent: true

---
# Security headers middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
    name: security-headers
    namespace: epicalendar
spec:
    headers:
        customRequestHeaders:
            X-Forwarded-Proto: "https"
        customResponseHeaders:
            X-Content-Type-Options: "nosniff"
            X-Frame-Options: "DENY"
            X-XSS-Protection: "1; mode=block"
            Referrer-Policy: "strict-origin-when-cross-origin"
            Permissions-Policy: "camera=(), microphone=(), geolocation=()"
        contentSecurityPolicy: "default-src 'self' blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https: blob:; connect-src 'self' https://epicalendar.tek-nice.eu; worker-src 'self' blob:"
        forceSTSHeader: true
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true

---
# Rate limiting middleware
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
    name: rate-limit
    namespace: epicalendar
spec:
    rateLimit:
        average: 100
        period: 1s
        burst: 50
